(function(h){function $(a){a=a.replace(/\\/g,"/");return a.substring(a.lastIndexOf("/")+1)}function L(a){var b=h(a),c=b.find(".optional .textinput:first");b.data("titleUnchanged",true);c.keyup(function(){b.data("titleUnchanged",false)});b.find(".fileupload").change(function(){b.data("titleUnchanged")&&c.val($(h(this).val()))})}function M(a,b,c){if(b.hasClass("file-checker-error")){b.removeClass("f3-form-error file-checker-error");b.parent("label").prev(".typo3-messages").remove()}var d=c+0,f=false;
if(a.length>0)for(var g=0;g<a.length;g++){var e=a[g];d=c+g;if(N.length>0){var k=aa(e.type,'"');x(b,!(new RegExp("^("+N+")","i")).test(k),"File type denied for '"+e.name+"': "+e.type,"###VALID_FAIL_MIMETYPE###".replace("{fileName}",e.name))||(f=true)}if(y>0)x(b,e.size>y,"File size "+e.size+" of '"+e.name+"' exceeds set limit: "+y,"###VALID_FAIL_MAXFILESIZE###".replace("{maxFileSize}",z(y)).replace("{fileName}",e.name))||(f=true);p[d]=e.size}else p.hasOwnProperty(d)&&delete p[d];u=0;for(g in p)if(p.hasOwnProperty(g))u+=
p[g];O=z(u);if(A>0)x(b,u>A,"Total file size "+u+" exceeds set limit: "+A,"###VALID_FAIL_TOTFILESIZE###".replace("{maxTotalFileSize}",z(A)))||(f=true);return!f}function x(a,b,c,d){if(b){console.log(c);a.val(null);a.addClass("f3-form-error file-checker-error");F(d,a.parent("label"));return false}return true}function F(a,b){a='<li class="alert alert-danger"><p class="alert-message">'+a+"</p></li>";var c=b.prev(".typo3-messages");c[0]?c.append(a):b.before('<ul class="typo3-messages">'+a+"</ul>")}function aa(a,
b){for(;a.charAt(0)===b;)a=a.substring(1);for(;a.charAt(a.length-1)===b;)a=a.substring(0,a.length-1);return a}function z(a){if(a==0)return"n/a";var b=parseInt(Math.floor(Math.log(a)/Math.log(1024)));return(a/Math.pow(1024,b)).toFixed(1)+" "+["Bytes","KB","MB","GB","TB"][b]}function P(a,b){h.get("/typo3conf/ext/fileman/Resources/Public/Scripts/UploadProgress.php",{upload_id:a,no_cache:Math.random(),type:v},function(c){var d=parseInt(c),f=l.find("#fileman-uploadProgress"+b),g=f.find(".progressvalue");
if(w=="1"&&isNaN(d))g.html("Not receiving upload-progress status: "+c);else{f.find(".progressbar").css({width:d+"%"});if(d==100){clearInterval(Q[b]);g.text(B+" 99%")}else g.text(B+" "+d+"%")}})}function ba(){if(G==="js"){l.find(".init-progressbar").each(function(a,b){a++;h(b).on("submit",function(c){if(!H){c.preventDefault();ca(this,a)}})});R=true}}function ca(a,b){var c=0,d=h(a);d.find(".fileupload").each(function(f,g){f=h(g);var e=S(f);if(g.files!==undefined&&g.files!==null&&g.files.length>0&&g.files[0]instanceof
File&&g.files[0].name.length>0){C.push({file:g.files[0],uploadIndex:e,form:a});f.after('<input type="text" name="tx_fileman_filelist[files][file][i'+e+'][fileUri]" readonly="readonly" class="fileupload fill-'+e+'" value="" /><input type="hidden" name="tx_fileman_filelist[tmpFiles][i'+e+']" class="tmpfile fill-'+e+'" value="" />');f.remove()}else{g=f.val();g!==undefined&&g.length>0&&c++}});if(C.length>0){d.hide();t=l.find("#fileman-uploadProgress"+b);t.show();b=C.shift();I(b.file,b.uploadIndex,b.form)}else if(c>
0){H=true;d.submit()}}function I(a,b,c){var d=new FileReader,f=new XMLHttpRequest,g=0,e=D,k=u*1.33,n=0,q=a.name;d.onload=function(i){f.open("PUT","/typo3conf/ext/fileman/Resources/Public/Scripts/FileTransfer.php?filename="+q+"&state="+n+"&no_cache="+Math.random());f.setRequestHeader("Content-Type","application/octet-stream");f.responseType="json";f.send(i.target.result)};d.onerror=function(){console.log("ERROR: Could not read file")};f.addEventListener("load",function(i){n=1;if(i.target.response){i=
i.target.response;if(typeof i!=="object")i=JSON.parse(i);w=="1"&&console.log(i);if(i.success&&i.success===1){if(i.tmp_name)q=i.tmp_name;if(e<a.size){g=e;e+=D;if(e>a.size)e=a.size;d.readAsDataURL(a.slice(g,e))}else{i=h(c);i.find(".tmpfile.fill-"+b).val(q);i.find(".fileupload.fill-"+b).val(a.name);var m=C.shift();if(m===undefined){H=true;i.submit()}else I(m.file,m.uploadIndex,m.form)}}else{console.log("ERROR: File transfer failure");F("###ERROR_FILE_TRANSFER###",t)}}else{console.log("ERROR: No valid XHR response");
F("###ERROR_XHR_RESPONSE###",t);w=="1"&&console.log(i)}},false);f.addEventListener("error",function(){console.log("ERROR: No connection, retrying in 30 seconds");t.find(".progressvalue").text("###XHR_RETRY###");setTimeout(function(){I(a,b,c)},3E4)},false);f.upload.addEventListener("progress",function(i){var m=t.find(".progressvalue"),T=t.find(".progressbar");if(m[0]&&T[0])if(i.lengthComputable){var V=U+i.loaded,r=V/k*100;if(r>100)r=100;w=="1"&&console.log(r);T.css({width:r+"%"});r=parseInt(r);r===
100?m.text(B+" 99%"):m.text(B+" "+r+"% ("+z(V/1.33)+" / "+O+")");if(i.loaded===i.total)U+=i.total}else w=="1"&&m.html("###XHR_NO_PROGRESS###")},false);if(e>a.size)e=a.size;d.readAsDataURL(a.slice(g,e))}function W(a,b,c,d){c=h(c);if(a.fileCount>1&&!c.hasClass("disabled")){a.fileCount==o&&b.removeClass("disabled");a.fileCount--;b=c.parents(".file-entry");c=b.find("input[type=file].fileupload");c.val(null);c.change();b.remove();a.lastIndex=X(d);a.fileCount==1&&h(d).find("a.del-file-entry").addClass("disabled")}}
function X(a){return S(h(a).find(".fileupload:last"))}function S(a){return a.attr("name").match(/\[file\]\[i([0-9]+)\]/i)[1]}function Y(a,b){a.slideToggle();h(b).toggleClass("expanded")}function Z(a){if(E){a.hide();E=false}}function da(a,b){var c=a.dataTransfer,d=[];if(c.items)for(a=0;a<c.items.length;a++)c.items[a].kind=="file"&&d.push(c.items[a].getAsFile());else d=c.files;if(d.length>0){b=h(b);a=b.find(".file-entry");c=a.first().find(".fileupload");if(c.hasClass("file-checker-error")){c.removeClass("f3-form-error file-checker-error");
c.parent("label").prev(".typo3-messages").remove()}if(!x(c,d.length>o,"Max file count is "+o+", tried uploading "+d.length,"###VALID_FAIL_FILECOUNT###".replace("{maxFileCount}",o)))return false;p={};if(!M(d,c,"dragNdrop")){p={};return false}if(d.length!==a.length)if(d.length>a.length){c=d.length-a.length;var f=b.find("a.add-file-entry");for(a=0;a<c;a++)f.click()}else a.slice((a.length-d.length)*-1).remove();b.find(".file-entry").each(function(g,e){e=h(".fileupload",e);var k=h('<span class="fileupload" name="'+
e.attr("name")+'">'+d[g].name+"</span>");k[0].files=[d[g]];e.replaceWith(k)});b.submit()}}var l=h(".tx-fileman"),j=l.find(".search-form .searchbox");if(j[0]){var ea=j.width(),s=j[0].value.trim();j.val().length>0&&j.css({width:"85%"});j.on("focus",function(){this.value.length<1&&h(this).animate({width:"85%"})});j.on("blur",function(){this.value.length<1&&h(this).animate({width:ea})});if(s.length>0){s=s.split(" ");for(var J in s)s.hasOwnProperty(J)&&s[J].length<1&&s.splice(J,1);var fa=new RegExp("("+
s.join("|")+")(?![^<]*>|[^<>]</)","ig");l.find("table.tx_fileman").each(function(a,b){a=h(b);a.html(a.html().replace(fa,'<span class="search-match">$1</span>'))})}}j=l.find(".rel-switch");j.click(function(){h(this).next(".tx-fileman .rel-links").slideToggle();return false});j.show();l.find(".rel-links").hide();l.find(".button-delete").click(function(a){if(confirm("###DELETE_CONFIRM###"))return true;else{a.stopImmediatePropagation();return false}});l.find(".file-entry").each(function(a,b){L(b)});var K=
""+(new Date).getTime()+Math.random();K=K.replace(".","");var Q={},B="###SENDING_FILE###",w="###DEBUG###",v="###UPLOADPROGRESS###",G="###UPLOADTYPE###",C=[],R=false,H=false,N="###ALLOW_MIMETYPE###",y=parseInt("###MAX_FILESIZE###"),A=parseInt("###MAX_TOTAL_FILESIZE###"),p={},u=0,O="",U=0,D=parseInt("###CHUNKSIZE###"),t=null;if(D<1)D=1048576;if(window.File){l.find("form").on("change","input[type=file].fileupload",function(){var a=h(this);if(!M(this.files,a,a.attr("name")))return false});window.FileReader&&
ba()}if(G==="js"||v!="none")l.find(".init-progressbar").each(function(a,b){a++;var c=h(b);c.after('<div id="fileman-uploadProgress'+a+'" class="uploadprogress"><div class="progressbar"></div><div class="progressvalue"></div></div>');if(G!=="js"){var d=a+K;if(v=="session")c.prepend('<input type="hidden" name="###SES_FIELD_NAME###" value="'+d+'" />');else if(v=="apc")c.prepend('<input type="hidden" name="###APC_FIELD_NAME###" value="'+d+'" />');else v=="uploadprogress"&&c.prepend('<input type="hidden" name="UPLOAD_IDENTIFIER" value="'+
d+'" />');c.on("submit",function(){var f=c.find("input[type=file].fileupload").val();if(f!==undefined&&f!==""){c.hide();l.find("#fileman-uploadProgress"+a).show();Q[a]=setInterval(function(){P(d,a)},100);P(d,a)}})}});var o=parseInt("###MAX_FILE_UPLOADS###");o>1&&l.find(".multi-file").each(function(a,b){var c=h(b);a=c.find(".file-entry");var d={fileCount:a.length,lastIndex:X(b)};c.find(".submit").before('<a href="#" class="add-file-entry" title="###ADD_FILE###">###ADD_FILE###</a><a href="#" class="del-file-entry" title="###DEL_FILE###">###DEL_FILE###</a>');
var f=c.find("a.add-file-entry"),g=f.next("a.del-file-entry");g.remove();d.fileCount==o&&f.addClass("disabled");d.fileCount==1&&g.addClass("disabled");c.hasClass("multi-file-add")||f.hide();a.each(function(e,k){e=h(k);k=e.find(".fileupload");var n=h(g.clone());n.insertAfter(k);n.click(function(){W(d,f,this,b);return false});var q=e.find(".optional");q.hide().addClass("indent");k.after('<a href="#" class="show-optional" title="###SHOW_OPTIONAL###">###SHOW_OPTIONAL###</a>');e.find(".show-optional").click(function(){Y(q,
this);return false})});if(c.hasClass("multi-file-add"))f.click(function(){var e=h(this);if(d.fileCount<o&&!e.hasClass("disabled")){d.fileCount==1&&c.find("a.del-file-entry").removeClass("disabled");d.fileCount++;var k=e.prevAll(".file-entry:first").clone(),n=h(k),q="[file][i"+d.lastIndex+"]";replaceName="[file][i"+ ++d.lastIndex+"]";n.find("input[type=file],input[type=text],textarea").each(function(i,m){i=h(m);i.attr("name",i.attr("name").replace(q,replaceName));i.val(null)});n.find(".show-optional").click(function(){Y(n.find(".optional"),
this);return false});L(k);n.find("a.del-file-entry").click(function(){W(d,f,this,b);return false});e.before(k);d.fileCount==o&&f.addClass("disabled")}return false});else o=1});var E=false;if(R&&"draggable"in document.createElement("span")){j=l.find(".drop-zone");if(j.length>0){j.prepend('<div class="drop-overlay"></div><div class="drop-here" title="###DROP_ZONE_TOOLTIP###">###DROP_ZONE###</div>');j.on("drop",function(a){a.originalEvent.preventDefault();var b=h(".drop-overlay",this);b.toggleClass("loading");
if(!da(a.originalEvent,this)){Z(b);b.toggleClass("loading")}});j.on("dragover",function(a){a.originalEvent.preventDefault()});j.on("dragenter",function(a){a.originalEvent.preventDefault();a.originalEvent.stopPropagation();if(!E){h(".drop-overlay",this).show();E=true}});j.find(".drop-overlay").on("dragleave",function(a){a.originalEvent.preventDefault();a.originalEvent.stopPropagation();Z(h(this))})}}})(jQuery);