jQuery(document).ready(function(){function Z(a){a=a.replace(/\\/g,"/");return a.substring(a.lastIndexOf("/")+1)}function K(a){var b=jQuery(a),c=b.find(".optional .textinput:first");b.data("titleUnchanged",true);c.keyup(function(){b.data("titleUnchanged",false)});b.find(".fileupload").change(function(){b.data("titleUnchanged")&&c.val(Z(jQuery(this).val()))})}function L(a,b,c){if(b.hasClass("file-checker-error")){b.removeClass("f3-form-error file-checker-error");b.parent("label").prev(".typo3-messages").remove()}var d=
c+0,f=false;if(a.length>0)for(var g=0;g<a.length;g++){var e=a[g];d=c+g;if(M.length>0){var j=$(e.type,'"');w(b,!(new RegExp("^("+M+")","i")).test(j),"File type denied for '"+e.name+"': "+e.type,"###VALID_FAIL_MIMETYPE###".replace("{fileName}",e.name))||(f=true)}if(x>0)w(b,e.size>x,"File size "+e.size+" of '"+e.name+"' exceeds set limit: "+x,"###VALID_FAIL_MAXFILESIZE###".replace("{maxFileSize}",y(x)).replace("{fileName}",e.name))||(f=true);o[d]=e.size}else o.hasOwnProperty(d)&&delete o[d];t=0;for(g in o)if(o.hasOwnProperty(g))t+=
o[g];N=y(t);if(z>0)w(b,t>z,"Total file size "+t+" exceeds set limit: "+z,"###VALID_FAIL_TOTFILESIZE###".replace("{maxTotalFileSize}",y(z)))||(f=true);return!f}function w(a,b,c,d){if(b){console.log(c);a.val(null);a.addClass("f3-form-error file-checker-error");E(d,a.parent("label"));return false}return true}function E(a,b){a='<li class="alert alert-danger"><p class="alert-message">'+a+"</p></li>";var c=b.prev(".typo3-messages");c[0]?c.append(a):b.before('<ul class="typo3-messages">'+a+"</ul>")}function $(a,
b){for(;a.charAt(0)===b;)a=a.substring(1);for(;a.charAt(a.length-1)===b;)a=a.substring(0,a.length-1);return a}function y(a){if(a==0)return"n/a";var b=parseInt(Math.floor(Math.log(a)/Math.log(1024)));return(a/Math.pow(1024,b)).toFixed(1)+" "+["Bytes","KB","MB","GB","TB"][b]}function O(a,b){jQuery.get("/typo3conf/ext/fileman/Resources/Public/Scripts/UploadProgress.php",{upload_id:a,no_cache:Math.random(),type:u},function(c){var d=parseInt(c),f=k.find("#fileman-uploadProgress"+b),g=f.find(".progressvalue");
if(v=="1"&&isNaN(d))g.html("Not receiving upload-progress status: "+c);else{f.find(".progressbar").css({width:d+"%"});if(d==100){clearInterval(P[b]);g.text(A+" 99%")}else g.text(A+" "+d+"%")}})}function aa(){if(F==="js"){k.find(".init-progressbar").each(function(a,b){a++;jQuery(b).on("submit",function(c){if(!G){c.preventDefault();ba(this,a)}})});Q=true}}function ba(a,b){var c=0,d=jQuery(a);d.find(".fileupload").each(function(f,g){f=jQuery(g);var e=R(f);if(g.files!==undefined&&g.files!==null&&g.files.length>
0&&g.files[0]instanceof File&&g.files[0].name.length>0){B.push({file:g.files[0],uploadIndex:e,form:a});f.after('<input type="text" name="tx_fileman_filelist[files][file][i'+e+'][fileUri]" readonly="readonly" class="fileupload fill-'+e+'" value="" /><input type="hidden" name="tx_fileman_filelist[tmpFiles][i'+e+']" class="tmpfile fill-'+e+'" value="" />');f.remove()}else{g=f.val();g!==undefined&&g.length>0&&c++}});if(B.length>0){d.hide();s=k.find("#fileman-uploadProgress"+b);s.show();b=B.shift();H(b.file,
b.uploadIndex,b.form)}else if(c>0){G=true;d.submit()}}function H(a,b,c){var d=new FileReader,f=new XMLHttpRequest,g=0,e=C,j=t*1.33,m=0,p=a.name;d.onload=function(h){f.open("PUT","/typo3conf/ext/fileman/Resources/Public/Scripts/FileTransfer.php?filename="+p+"&state="+m+"&no_cache="+Math.random());f.setRequestHeader("Content-Type","application/octet-stream");f.responseType="json";f.send(h.target.result)};d.onerror=function(){console.log("ERROR: Could not read file")};f.addEventListener("load",function(h){m=
1;if(h.target.response){h=h.target.response;if(typeof h!=="object")h=JSON.parse(h);v=="1"&&console.log(h);if(h.success&&h.success===1){if(h.tmp_name)p=h.tmp_name;if(e<a.size){g=e;e+=C;if(e>a.size)e=a.size;d.readAsDataURL(a.slice(g,e))}else{h=jQuery(c);h.find(".tmpfile.fill-"+b).val(p);h.find(".fileupload.fill-"+b).val(a.name);var l=B.shift();if(l===undefined){G=true;h.submit()}else H(l.file,l.uploadIndex,l.form)}}else{console.log("ERROR: File transfer failure");E("###ERROR_FILE_TRANSFER###",s)}}else{console.log("ERROR: No valid XHR response");
E("###ERROR_XHR_RESPONSE###",s);v=="1"&&console.log(h)}},false);f.addEventListener("error",function(){console.log("ERROR: No connection, retrying in 30 seconds");s.find(".progressvalue").text("###XHR_RETRY###");setTimeout(function(){H(a,b,c)},3E4)},false);f.upload.addEventListener("progress",function(h){var l=s.find(".progressvalue"),S=s.find(".progressbar");if(l[0]&&S[0])if(h.lengthComputable){var U=T+h.loaded,q=U/j*100;if(q>100)q=100;v=="1"&&console.log(q);S.css({width:q+"%"});q=parseInt(q);q===
100?l.text(A+" 99%"):l.text(A+" "+q+"% ("+y(U/1.33)+" / "+N+")");if(h.loaded===h.total)T+=h.total}else v=="1"&&l.html("###XHR_NO_PROGRESS###")},false);if(e>a.size)e=a.size;d.readAsDataURL(a.slice(g,e))}function V(a,b,c,d){c=jQuery(c);if(a.fileCount>1&&!c.hasClass("disabled")){a.fileCount==n&&b.removeClass("disabled");a.fileCount--;b=c.parents(".file-entry");c=b.find("input[type=file].fileupload");c.val(null);c.change();b.remove();a.lastIndex=W(d);a.fileCount==1&&jQuery(d).find("a.del-file-entry").addClass("disabled")}}
function W(a){return R(jQuery(a).find(".fileupload:last"))}function R(a){return a.attr("name").match(/\[file\]\[i([0-9]+)\]/i)[1]}function X(a,b){a.slideToggle();jQuery(b).toggleClass("expanded")}function Y(a){if(D){a.hide();D=false}}function ca(a,b){var c=a.dataTransfer,d=[];if(c.items)for(a=0;a<c.items.length;a++)c.items[a].kind=="file"&&d.push(c.items[a].getAsFile());else d=c.files;if(d.length>0){b=jQuery(b);a=b.find(".file-entry");c=a.first().find(".fileupload");if(c.hasClass("file-checker-error")){c.removeClass("f3-form-error file-checker-error");
c.parent("label").prev(".typo3-messages").remove()}if(!w(c,d.length>n,"Max file count is "+n+", tried uploading "+d.length,"###VALID_FAIL_FILECOUNT###".replace("{maxFileCount}",n)))return false;o={};if(!L(d,c,"dragNdrop")){o={};return false}if(d.length!==a.length)if(d.length>a.length){c=d.length-a.length;var f=b.find("a.add-file-entry");for(a=0;a<c;a++)f.click()}else a.slice((a.length-d.length)*-1).remove();b.find(".file-entry").each(function(g,e){e=jQuery(".fileupload",e);var j=jQuery('<span class="fileupload" name="'+
e.attr("name")+'">'+d[g].name+"</span>");j[0].files=[d[g]];e.replaceWith(j)});b.submit()}}var k=jQuery(".tx-fileman"),i=k.find(".search-form .searchbox");if(i[0]){var da=i.width(),r=i[0].value.trim();i.val().length>0&&i.css({width:"85%"});i.on("focus",function(){this.value.length<1&&jQuery(this).animate({width:"85%"})});i.on("blur",function(){this.value.length<1&&jQuery(this).animate({width:da})});if(r.length>0){r=r.split(" ");for(var I in r)r.hasOwnProperty(I)&&r[I].length<1&&r.splice(I,1);var ea=
new RegExp("("+r.join("|")+")(?![^<]*>|[^<>]</)","ig");k.find("table.tx_fileman").each(function(a,b){a=jQuery(b);a.html(a.html().replace(ea,'<span class="search-match">$1</span>'))})}}i=k.find(".rel-switch");i.click(function(){jQuery(this).next(".tx-fileman .rel-links").slideToggle();return false});i.show();k.find(".rel-links").hide();k.find(".button-delete").click(function(a){if(confirm("###DELETE_CONFIRM###"))return true;else{a.stopImmediatePropagation();return false}});k.find(".file-entry").each(function(a,
b){K(b)});var J=""+(new Date).getTime()+Math.random();J=J.replace(".","");var P={},A="###SENDING_FILE###",v="###DEBUG###",u="###UPLOADPROGRESS###",F="###UPLOADTYPE###",B=[],Q=false,G=false,M="###ALLOW_MIMETYPE###",x=parseInt("###MAX_FILESIZE###"),z=parseInt("###MAX_TOTAL_FILESIZE###"),o={},t=0,N="",T=0,C=parseInt("###CHUNKSIZE###"),s=null;if(C<1)C=1048576;if(window.File){k.find("form").on("change","input[type=file].fileupload",function(){var a=jQuery(this);if(!L(this.files,a,a.attr("name")))return false});
window.FileReader&&aa()}if(F==="js"||u!="none")k.find(".init-progressbar").each(function(a,b){a++;var c=jQuery(b);c.after('<div id="fileman-uploadProgress'+a+'" class="uploadprogress"><div class="progressbar"></div><div class="progressvalue"></div></div>');if(F!=="js"){var d=a+J;if(u=="session")c.prepend('<input type="hidden" name="###SES_FIELD_NAME###" value="'+d+'" />');else if(u=="apc")c.prepend('<input type="hidden" name="###APC_FIELD_NAME###" value="'+d+'" />');else u=="uploadprogress"&&c.prepend('<input type="hidden" name="UPLOAD_IDENTIFIER" value="'+
d+'" />');c.on("submit",function(){var f=c.find("input[type=file].fileupload").val();if(f!==undefined&&f!==""){c.hide();k.find("#fileman-uploadProgress"+a).show();P[a]=setInterval(function(){O(d,a)},100);O(d,a)}})}});var n=parseInt("###MAX_FILE_UPLOADS###");n>1&&k.find(".multi-file").each(function(a,b){var c=jQuery(b);a=c.find(".file-entry");var d={fileCount:a.length,lastIndex:W(b)};c.find(".submit").before('<a href="#" class="add-file-entry" title="###ADD_FILE###">###ADD_FILE###</a><a href="#" class="del-file-entry" title="###DEL_FILE###">###DEL_FILE###</a>');
var f=c.find("a.add-file-entry"),g=f.next("a.del-file-entry");g.remove();d.fileCount==n&&f.addClass("disabled");d.fileCount==1&&g.addClass("disabled");c.hasClass("multi-file-add")||f.hide();a.each(function(e,j){e=jQuery(j);j=e.find(".fileupload");var m=jQuery(g.clone());m.insertAfter(j);m.click(function(){V(d,f,this,b);return false});var p=e.find(".optional");p.hide().addClass("indent");j.after('<a href="#" class="show-optional" title="###SHOW_OPTIONAL###">###SHOW_OPTIONAL###</a>');e.find(".show-optional").click(function(){X(p,
this);return false})});if(c.hasClass("multi-file-add"))f.click(function(){var e=jQuery(this);if(d.fileCount<n&&!e.hasClass("disabled")){d.fileCount==1&&c.find("a.del-file-entry").removeClass("disabled");d.fileCount++;var j=e.prevAll(".file-entry:first").clone(),m=jQuery(j),p="[file][i"+d.lastIndex+"]";replaceName="[file][i"+ ++d.lastIndex+"]";m.find("input[type=file],input[type=text],textarea").each(function(h,l){h=jQuery(l);h.attr("name",h.attr("name").replace(p,replaceName));h.val(null)});m.find(".show-optional").click(function(){X(m.find(".optional"),
this);return false});K(j);m.find("a.del-file-entry").click(function(){V(d,f,this,b);return false});e.before(j);d.fileCount==n&&f.addClass("disabled")}return false});else n=1});var D=false;if(Q&&"draggable"in document.createElement("span")){i=k.find(".drop-zone");if(i.length>0){i.prepend('<div class="drop-overlay"></div><div class="drop-here" title="###DROP_ZONE_TOOLTIP###">###DROP_ZONE###</div>');i.on("drop",function(a){a.originalEvent.preventDefault();var b=jQuery(".drop-overlay",this);b.toggleClass("loading");
if(!ca(a.originalEvent,this)){Y(b);b.toggleClass("loading")}});i.on("dragover",function(a){a.originalEvent.preventDefault()});i.on("dragenter",function(a){a.originalEvent.preventDefault();a.originalEvent.stopPropagation();if(!D){jQuery(".drop-overlay",this).show();D=true}});i.find(".drop-overlay").on("dragleave",function(a){a.originalEvent.preventDefault();a.originalEvent.stopPropagation();Y(jQuery(this))})}}});